<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Davidson County Building Permits 2021-2024</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .node {
            cursor: pointer;
        }
        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 3px;
        }
        .node text {
            font: 12px sans-serif;
            pointer-events: none;
            white-space: pre-wrap;
        }
        .value-text {
            font: bold 14px sans-serif;
            fill: black;
        }
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }
        .tooltip {
            position: absolute;
            background: lightgrey;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px;
            visibility: hidden;
        }
        .legend {
            font: 12px sans-serif;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <svg width="1200" height="600"></svg> <!-- Increased width for the bar chart -->
    <div class="tooltip"></div>
    <script>
        const url = 'https://raw.githubusercontent.com/joy-ald/City/refs/heads/main/buildings_hierarchy_d3.json'; // Your JSON URL

        d3.json(url).then(data => {
            const rootData = data.city; 
            const root = d3.hierarchy(rootData, d => d.children);
            root.descendants().forEach(d => {
                d._children = d.children;
                if (d.children) d.children = null; 
            });

            const svg = d3.select("svg"),
                width = +svg.attr("width"),
                height = +svg.attr("height"),
                radius = Math.min(width, height) / 2 - 40; 

            const g = svg.append("g").attr("transform", `translate(${width / 3}, ${height / 2})`); // Shift to the left

            const tree = d3.tree()
                .size([2 * Math.PI, radius])
                .separation((a, b) => (a.parent == b.parent ? 0.5 : 1.5)); // Reduce separation

            update(root);

            function click(event, d) {
                if (d.children) {
                    d.children = null; 
                } else {
                    d.children = d._children; 
                }
                update(root);
            }

            function calculateValue(d) {
                if (d.children) {
                    return d.children.reduce((sum, child) => sum + calculateValue(child), 0);
                }
                return d.data.value || 0;
            }

            function update(source) {
                const nodes = root.descendants(),
                    links = root.links();

                tree(root);

                nodes.forEach(d => {
                    d.x = d.x; // Angle in radians
                    d.y = d.y; // Radius
                });

                const node = g.selectAll(".node")
                    .data(nodes, d => d.data.zip_code || d.data.building_type);

                const nodeEnter = node.enter().append("g")
                    .attr("class", d => "node" + (d.children ? " node--internal" : " node--leaf"))
                    .attr("transform", d => `rotate(${(d.x * 180 / Math.PI) - 90}) translate(${d.y}, 0)`)
                    .on("click", click)
                    .on("mouseover", (event, d) => {
                        const valueToDisplay = d.data.zip_code !== undefined
                            ? `$${calculateValue(d)}`
                            : `$${d.data.value}`;
                        d3.select(".tooltip")
                            .style("visibility", "visible")
                            .text(valueToDisplay);
                    })
                    .on("mousemove", (event) => {
                        d3.select(".tooltip")
                            .style("top", (event.pageY - 10) + "px")
                            .style("left", (event.pageX + 10) + "px");
                    })
                    .on("mouseout", () => {
                        d3.select(".tooltip").style("visibility", "hidden");
                    });

                const nodeDiameter = d => d.depth === 0 ? 10 : (10 / Math.pow(2, d.depth));
                nodeEnter.append("circle")
                    .attr("r", d => nodeDiameter(d))
                    .attr("fill", d => {
                        const maxValue = d3.max(nodes.filter(n => n.data.value), n => n.data.value);
                        const minValue = d3.min(nodes.filter(n => n.data.value), n => n.data.value);
                        if (d.data.value) {
                            return d.data.value === maxValue ? 'darkred' : (d.data.value === minValue ? 'lightcoral' : 'lightblue');
                        }
                        return '#fff';
                    });

                nodeEnter.append("text")
                    .attr("dy", 15)
                    .attr("x", d => d.children ? -20 : 20)
                    .style("text-anchor", d => d.children ? "end" : "start")
                    .text(d => {
                        if (d.data.zip_code !== undefined) {
                            return `${d.data.zip_code}`;
                        } else if (d.data.building_type) {
                            const buildingTypeMap = {
                                "Building Residential - New": "ResN",
                                "Building Commercial - New": "ComN",
                                "Building Commercial - Rehab": "ComR"
                            };
                            return buildingTypeMap[d.data.building_type] || d.data.building_type;
                        }
                        return d.data.parent || "";
                    });

                nodeEnter.merge(node)
                    .transition()
                    .duration(750)
                    .attr("transform", d => `rotate(${(d.x * 180 / Math.PI) - 90}) translate(${d.y}, 0)`);

                node.exit().remove();

                const link = g.selectAll(".link")
                    .data(links, d => d.target.data.zip_code || d.target.data.building_type);

                link.enter().append("path")
                    .attr("class", "link")
                    .attr("d", d3.linkRadial()
                        .angle(d => d.x)
                        .radius(d => d.y * 0.9)) // Reduce link length
                    .merge(link)
                    .transition()
                    .duration(750)
                    .attr("d", d3.linkRadial()
                        .angle(d => d.x)
                        .radius(d => d.y * 0.9)); // Reduce link length

                link.exit().remove();
            }
        });
    </script>
    <div id="bar-chart" style="float: right; width: 400px;"></div> <!-- Container for the bar chart -->
</body>
</html>
